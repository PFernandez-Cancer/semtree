

library(lavaan)

skip_on_cran()

N <- 200
# random numbers generated once for reproducibility across platforms
x <- c(-0.91,-0.83,0.26,0.78,0.59,1.54,0.83,0.14,-1.44,-0.84,0.09,-0.86,-1.2,
       -1.03,0.54,-0.23,1.28,0.72,0.22,0.65,-2.29,1.49,0.94,-0.68,-0.14,-0.59,
       1.24,0.23,0.3,0.2,1.09,-3.29,-1.37,1.4,-1.17,-0.05,0.21,1,3.29,1.15,-0.55,
       -1.35,0.47,-0.78,0.04,-0.17,-0.88,0.4,2.1,-0.42,-1.71,0.7,-0.98,0.45,
       -0.03,1.11,0.16,-1.4,0.42,-0.44,0.33,1.77,-0.02,0.97,-0.26,0.18,0.49,1,
       0.51,-0.17,0.87,-0.56,0.39,0.43,0.72,-1.28,1.49,1.49,-1.23,-0.79,1.28,
       0.44,-1.04,1.7,0.06,0.23,-0.56,-1.25,-1.6,-0.26,0.6,-0.43,0.46,-0.13,
       -0.11,-1.03,-1.95,-2.21,0.89,-0.03,0.62,0.04,0.99,1.04,0.17,1.52,1.43,
       -0.34,0.05,0.38,0.19,-1.25,-0.41,0.65,0.18,0.17,-1.11,2.31,-0.61,-0.31,
       -0.14,-0.99,-0.76,0.33,1.3,0.46,-0.74,0.07,1.26,2.08,2.8,-0.98,0.43,1.34,
       1.31,-1.28,-0.79,2.52,-1.12,-1.22,-1.18,-0.37,-1.11,1.5,0.22,2.54,0.28,
       1.26,0.64,-0.79,-0.08,-0.57,0.18,-0.2,0.85,-1.18,0.2,-0.37,-0.74,-0.8
       ,1.09,1.34,1.95,-1.05,0.31,0.36,-1.43,-0.44,-1.05,0.73,-0.46,0.64,2.09,
       1.33,-0.08,1.09,-0.24,-0.28,1.58,-1.04,1.55,1.15,0.66,-0.03,-0.77,-0.37,
       0.47,1.33,0.6,-0.77,-0.11,-0.91,2.33,2.44,0.37,-0.25,-0.57,-0.05,0.33,-1.27)
y <- c(0.66,1.46,-0.87,0.41,-0.47,-0.54,-0.93,0.58,-0.7,-0.2,1.19,-2.26,0.02,
       1.89,-0.92,0.06,-1.07,2.11,0.16,0,0.44,-0.42,-0.54,-1.21,1.27,0.16,0.21,
       -0.98,-1.25,0.2,-0.46,0.06,-0.37,0.8,-0.01,0.58,0.6,-1.11,-0.63,-1.1,
       0.36,2.06,-0.27,-0.6,1.55,-0.67,1.14,-0.22,-0.81,-0.22,0.7,0.03,-1.44,
       0.42,0.03,-0.99,-0.83,0.42,1.7,-0.7,0.78,-0.56,-1.37,-0.14,-1.01,0.14,
       -0.13,1.48,-0.93,-0.72,0.15,-0.29,-0.58,-0.44,-0.99,0.3,-0.76,-1,-0.5,
       -0.84,-0.02,0.52,-2.06,-2.16,-0.15,0.81,-1.63,0.21,-0.05,0.67,0.02,0.31,
       -0.55,0.08,-1.27,-1.67,0.6,1.26,1.66,0.71,0.12,1.16,1.03,1.13,0.4,-0.33,-0.56,-0.65,-0.15,-1.11,0.36,0.34,0.45,-0.38,1.77,0.62,-0.09,-0.55,-0.24,1.14,-0.16,-0.74,-1.38,0.16,-0.15,-1.31,-1.14,-1.2,0.64,0.59,-0.79,-0.45,-0.03,-1.15,0.08,-1.95,-0.78,-0.49,-0.19,0.54,0.51,-0.15,-0.44,0.06,0.62,0.96,-0.58,-0.71,-1.62,-1.02,-1.09,-1.91,-0.03,-1.21,0.22,1.5,-1.99,-2.27,-0.28,0.18,1.24,-0.52,-2.92,-1.57,1.08,-0.37,-0.13,1.22,1.07,1.17,1.81,-0.02,-0.89,-0.97,1.21,0.18,-1.38,-0.34,-2.5,-0.23,0,-2.43,0.78,-0.79,-1.25,0.4,-1.66,1.13,0.67,0.8,-1.42,0.05,0.91,-0.42,0.07,-1.56,1.33,-0.06,0.55,-0.7)

pred1 <- ordered( sample(c(0,1,2),N,replace=TRUE) )
pred2 <- sample(0:10, N, replace=TRUE)

y2 <- ifelse(pred2>5,0.2*y+0.8*x,x)              

model <- "x~~y; x~~x;y~~y"

df <- data.frame(x,y=y2,pred1,pred2)

fitted_model <- lavaan(model,df)
tree <- semtree(fitted_model, df)
plot(tree)

node_ids = traverse(tree, df)

node_ids_correct_top10 <- c(3,3,3,6,4,6,3,7,3,6)

test_that("traversal works correctly", { expect_equal(node_ids[1:10], node_ids_correct_top10)})

#
# further test for categorical variables
pred3 <- factor(sample(c("red","green","blue","yellow"), N, replace=TRUE))
y2 <- ifelse(pred3=="red" | pred3=="yellow",0.1*y+0.9*x,x)

model <- "x~~y; x~~x;y~~y"

df <- data.frame(x,y=y2,pred3)

fitted_model <- lavaan(model,df)
tree <- semtree(fitted_model, df)
plot(tree)

node_ids = traverse(tree, df)

node_ids_correct_top10 <- c(3,3,2,3,2,2,3,3,3,3)

test_that("traversal works correctly", { expect_equal(node_ids[1:10],
                                                      node_ids_correct_top10)})

# more tests for stripped traversal

tree_stripped <- strip(tree)
traverse_stripped(df[1,],tree_stripped,  what="parameters")
traverse_stripped(df[3,],tree_stripped,  what="parameters")
